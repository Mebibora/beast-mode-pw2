rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }
    function isPublic(data) { return data.visibility == "public"; }

    match /workouts/{id} {
      allow read: if isPublic(resource.data) || isOwner(resource.data.uid);
      allow create: if signedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isOwner(resource.data.uid);
    }

    match /journalEntries/{id} {
      allow read: if isPublic(resource.data) || isOwner(resource.data.uid);
      allow create: if signedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isOwner(resource.data.uid);
    }

    match /activities/{id} {
      allow read: if isPublic(resource.data);

      // Only the actor can create their activity
      allow create: if signedIn() && request.resource.data.uid == request.auth.uid;

      // Only actor can edit/delete (optionalâ€”many apps lock this down later)
      allow update, delete: if signedIn() && resource.data.uid == request.auth.uid;

      match /likes/{likeUid} {
        allow read: if true;
        allow create, delete: if signedIn() && request.auth.uid == likeUid;
      }

      match /comments/{commentId} {
        allow read: if true;
        allow create: if signedIn();
        allow delete: if signedIn() && resource.data.uid == request.auth.uid;
        allow update: if false;
      }
    }

    match /challenges/{id} {
      allow read: if isPublic(resource.data) || isOwner(resource.data.createdBy);
      allow create: if signedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.createdBy == request.auth.uid;

      match /members/{uid} {
        allow read: if true;
        allow create: if signedIn() && request.auth.uid == uid;
        allow update, delete: if signedIn() && request.auth.uid == uid;
      }
    }

    match /users/{uid} {
      allow read: if true;
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
    }

    match /users/{uid}/stats/{docId} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
    }
  }
}
